<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="Controle de aplica√ß√£o de Cipionato de Testosterona">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Controle Medica√ß√£o">

    <title>Controle de Medica√ß√£o - Cipionato de Testosterona</title>

    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .header p { font-size: 14px; opacity: 0.9; }

        .user-info {
            position: absolute;
            top: 15px; left: 15px;
            background: rgba(255,255,255,0.2);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sync-status {
            position: absolute;
            top: 15px; right: 15px;
            background: rgba(255,255,255,0.2);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .sync-status.online { background: rgba(40, 167, 69, 0.3); }
        .sync-status.offline { background: rgba(220, 53, 69, 0.3); }
        .sync-status.syncing { background: rgba(255, 193, 7, 0.3); }

        .install-prompt {
            background: #28a745;
            color: white;
            padding: 15px;
            text-align: center;
            display: none;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
        }
        .install-prompt.show { display: flex; }
        .install-prompt button {
            background: white;
            color: #28a745;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
        }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            flex-direction: column;
            gap: 20px;
        }
        .loading-overlay.show { display: flex; }
        .spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 50px; height: 50px;
            animation: spin 1s linear infinite;
        }
        .loading-text { color: white; font-size: 16px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .auth-screen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
        }
        .auth-screen.show { display: flex; }
        .auth-box {
            background: white;
            border-radius: 15px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .auth-box h2 { color: #667eea; margin-bottom: 10px; font-size: 24px; }
        .auth-box p { color: #666; margin-bottom: 25px; font-size: 14px; }

        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid #dee2e6;
        }
        .auth-tab {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }
        .auth-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        .auth-form { display: none; }
        .auth-form.active { display: block; }

        .content { padding: 30px; }

        .info-box, .warning-box {
            padding: 15px;
            margin-bottom: 25px;
            border-radius: 5px;
        }
        .info-box {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
        }
        .info-box h3 { color: #667eea; margin-bottom: 8px; font-size: 16px; }
        .info-box p { color: #666; font-size: 14px; margin-bottom: 5px; }

        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }
        .warning-box h3 { color: #856404; margin-bottom: 8px; font-size: 16px; }
        .warning-box p { color: #856404; font-size: 14px; }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102,126,234,0.4); }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }

        .btn-logout {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 6px 12px;
            font-size: 11px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            margin-bottom: 25px;
        }

        table { width: 100%; border-collapse: collapse; background: white; }
        thead { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        th { padding: 15px; text-align: left; font-weight: 600; font-size: 14px; }
        td { padding: 12px 15px; border-bottom: 1px solid #dee2e6; font-size: 14px; }
        tbody tr:hover { background: #f8f9fa; }

        select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        select.aplicado-sim {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
            font-weight: 600;
        }
        select.aplicado-nao {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
            font-weight: 600;
        }

        select option:disabled {
            color: #999;
            font-style: italic;
            background: #f5f5f5;
        }

        select:has(option[value="Sim"]:disabled) {
            border-left: 3px solid #ffc107;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #667eea;
        }
        .stat-card h4 {
            color: #666;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        .stat-card p {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            inset: 0;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: slideDown 0.3s;
        }
        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to   { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px 30px;
            border-radius: 15px 15px 0 0;
        }
        .modal-header h2 { font-size: 22px; margin: 0; }
        .modal-body { padding: 30px; }
        .modal-footer { padding: 20px 30px; border-top: 1px solid #dee2e6; display: flex; gap: 10px; justify-content: flex-end; }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 14px; }
        .form-group input {
            width: 100%; padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
        }
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        .form-group input:disabled {
            background-color: #e9ecef;
            cursor: not-allowed;
        }
        .form-group small { display: block; margin-top: 5px; color: #666; font-size: 12px; }

        .close {
            color: white;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 20px;
        }
        .close:hover { opacity: 0.8; }

        .receita-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 5px;
        }
        .receita-ativa { background: #d4edda; color: #155724; }
        .receita-esgotada { background: #f8d7da; color: #721c24; }

        .receitas-list { margin-top: 20px; }
        .receita-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
            position: relative;
        }
        .receita-item h4 { color: #667eea; font-size: 14px; margin-bottom: 8px; }
        .receita-item p { font-size: 13px; color: #666; margin: 3px 0; }
        .receita-item .progress-bar {
            background: #e9ecef;
            height: 8px;
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }
        .receita-item .progress-fill {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            transition: width 0.3s;
        }
        .receita-actions {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 5px;
        }

        @media print {
            body { background: white; padding: 0; }
            .controls, .modal, .install-prompt, .sync-status, .user-info { display: none !important; }
            .container { box-shadow: none; }
        }

        @media (max-width:768px) {
            body { padding: 0; }
            .container { border-radius: 0; }
            .header h1 { font-size: 22px; }
            .user-info, .sync-status { position: static; margin: 10px auto 0; justify-content: center; }
            .controls { flex-direction: column; }
            .btn { width: 100%; justify-content: center; }
            th, td { padding: 10px 8px; font-size: 12px; }
            .modal-content { width: 95%; margin: 10% auto; }
            .content { padding: 15px; }
            .receita-actions { position: static; margin-top: 10px; justify-content: flex-start; }
            .auth-box { padding: 30px 20px; }
        }
    </style>
</head>
<body>
    <div id="authScreen" class="auth-screen show">
        <div class="auth-box">
            <h2>üîê Controle de Medica√ß√£o</h2>
            <p>Fa√ßa login ou crie sua conta para sincronizar seus dados.</p>

            <div class="auth-tabs">
                <button class="auth-tab active" onclick="trocarAba('login')">Login</button>
                <button class="auth-tab" onclick="trocarAba('registro')">Criar Conta</button>
            </div>

            <form id="formLogin" class="auth-form active" onsubmit="fazerLogin(event)">
                <div class="form-group">
                    <label for="loginEmail">E-mail</label>
                    <input type="email" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label for="loginSenha">Senha</label>
                    <input type="password" id="loginSenha" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%;">Entrar</button>
            </form>

            <form id="formRegistro" class="auth-form" onsubmit="fazerRegistro(event)">
                <div class="form-group">
                    <label for="registroEmail">E-mail</label>
                    <input type="email" id="registroEmail" required>
                    <small>Use um e-mail v√°lido para recupera√ß√£o de senha</small>
                </div>
                <div class="form-group">
                    <label for="registroSenha">Senha</label>
                    <input type="password" id="registroSenha" minlength="6" required>
                    <small>M√≠nimo 6 caracteres</small>
                </div>
                <div class="form-group">
                    <label for="registroConfirmaSenha">Confirme a senha</label>
                    <input type="password" id="registroConfirmaSenha" minlength="6" required>
                </div>
                <button type="submit" class="btn btn-success" style="width:100%;">Criar conta</button>
            </form>
        </div>
    </div>

    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text">Conectando...</div>
    </div>

    <div id="installPrompt" class="install-prompt">
        <span>üì± Instalar este app na tela inicial?</span>
        <div>
            <button onclick="instalarApp()">Instalar</button>
            <button onclick="fecharPromptInstalacao()" style="background:transparent;color:white;">Agora n√£o</button>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div class="user-info">
                <span id="userEmail">‚Äì</span>
                <button class="btn-logout" onclick="fazerLogout()">Sair</button>
            </div>
            <div id="syncStatus" class="sync-status offline">
                <span id="syncIcon">‚ö´</span>
                <span id="syncText">Offline</span>
            </div>
            <h1>üìã Controle de Medica√ß√£o</h1>
            <p>Cipionato de Testosterona - Aplica√ß√£o a cada 10 dias</p>
        </div>

        <div class="content">
            <div class="info-box">
                <h3>‚ÑπÔ∏è Informa√ß√µes do Tratamento</h3>
                <p><strong>Per√≠odo:</strong> 07/02/2026 a 31/12/2026</p>
                <p><strong>Intervalo:</strong> Vari√°vel conforme receita cadastrada</p>
                <p><strong>Medicamento:</strong> Cipionato de Testosterona (controlado)</p>
            </div>

            <div class="warning-box">
                <h3>‚ö†Ô∏è Controle de Receitas</h3>
                <p>Cada receita permite 3 doses (1 caixa). O interst√≠cio entre aplica√ß√µes √© definido ao cadastrar cada receita.</p>
            </div>

            <div class="controls">
                <button class="btn btn-info" onclick="abrirModalReceita()">üìù Cadastrar Receita</button>
                <button class="btn btn-primary" onclick="exportarPDF()">üìÑ Exportar Relat√≥rio PDF</button>
                <button class="btn btn-success" onclick="marcarTodasSim()">‚úì Marcar todas como aplicadas</button>
                <button class="btn btn-danger" onclick="limparTodas()">‚úó Limpar todas</button>
            </div>

            <div class="stats">
                <div class="stat-card"><h4>Total de Aplica√ß√µes</h4><p id="totalAplicacoes">0</p></div>
                <div class="stat-card"><h4>Aplicadas</h4><p id="totalAplicadas" style="color:#28a745;">0</p></div>
                <div class="stat-card"><h4>N√£o Aplicadas</h4><p id="totalNaoAplicadas" style="color:#dc3545;">0</p></div>
                <div class="stat-card"><h4>Taxa de Ades√£o</h4><p id="taxaAdesao">0%</p></div>
            </div>

            <div class="stats">
                <div class="stat-card" style="border-left-color:#17a2b8;"><h4>Receitas Cadastradas</h4><p id="totalReceitas" style="color:#17a2b8;">0</p></div>
                <div class="stat-card" style="border-left-color:#28a745;"><h4>Doses Dispon√≠veis</h4><p id="dosesDisponiveis" style="color:#28a745;">0</p></div>
                <div class="stat-card" style="border-left-color:#ffc107;"><h4>Doses Utilizadas</h4><p id="dosesUtilizadas" style="color:#ffc107;">0</p></div>
                <div class="stat-card" style="border-left-color:#dc3545;"><h4>Receitas Necess√°rias</h4><p id="receitasNecessarias" style="color:#dc3545;">0</p></div>
            </div>

            <div id="listaReceitas" class="receitas-list" style="display:none;">
                <h3 style="color:#667eea;margin-bottom:15px;">üìã Receitas Cadastradas</h3>
                <div id="receitasContainer"></div>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th style="width:60px;">#</th>
                            <th style="width:130px;">Data</th>
                            <th style="width:110px;">Dia</th>
                            <th style="width:150px;">Aplica√ß√£o</th>
                            <th>Receita Utilizada</th>
                        </tr>
                    </thead>
                    <tbody id="corpoTabela"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="modalReceita" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="fecharModalReceita()">&times;</span>
                <h2 id="modalReceitaTitulo">üìù Cadastrar Nova Receita</h2>
            </div>
            <div class="modal-body">
                <input type="hidden" id="receitaEditandoId">
                <div class="form-group">
                    <label for="codigoReceita">C√≥digo da Receita *</label>
                    <input type="text" id="codigoReceita" required>
                    <small>C√≥digo completo da receita</small>
                </div>
                <div class="form-group">
                    <label for="dataEmissao">Data de Emiss√£o *</label>
                    <input type="date" id="dataEmissao" required>
                </div>
                <div class="form-group">
                    <label for="dataValidade">Data de Validade</label>
                    <input type="date" id="dataValidade">
                </div>
                <div class="form-group">
                    <label for="intersticioAplicacao">Interst√≠cio entre Aplica√ß√µes (dias) *</label>
                    <input type="number" id="intersticioAplicacao" min="1" max="365" value="10" required>
                    <small>Intervalo em dias entre cada uma das 3 aplica√ß√µes desta receita</small>
                </div>
                <div class="form-group">
                    <label for="observacoes">Observa√ß√µes</label>
                    <input type="text" id="observacoes">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="fecharModalReceita()">Cancelar</button>
                <button class="btn btn-success" onclick="salvarReceita()">Salvar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, onSnapshot, enableIndexedDbPersistence } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAdtY0kQsMukgbJj6hKCQ3dHR17BfZyvUY",
            authDomain: "controle-medicacao-99cb5.firebaseapp.com",
            projectId: "controle-medicacao-99cb5",
            storageBucket: "controle-medicacao-99cb5.firebasestorage.app",
            messagingSenderId: "268683516299",
            appId: "1:268683516299:web:611fb5e4cc2d67e8f6b78e"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        enableIndexedDbPersistence(db).catch(() => {});

        window.db = db;
        window.auth = auth;
        window.currentUserId = null;

        window.mostrarLoading = function(show, texto='Conectando...') {
            const overlay = document.getElementById('loadingOverlay');
            const txt = document.querySelector('.loading-text');
            if (txt) txt.textContent = texto;
            overlay.classList.toggle('show', show);
        };

        window.atualizarStatusSync = function(status) {
            const statusEl = document.getElementById('syncStatus');
            const iconEl = document.getElementById('syncIcon');
            const textEl = document.getElementById('syncText');
            if (!statusEl || !iconEl || !textEl) return;
            statusEl.className = 'sync-status ' + status;
            if (status === 'online') { iconEl.textContent='üü¢'; textEl.textContent='Online'; }
            else if (status === 'offline') { iconEl.textContent='‚ö´'; textEl.textContent='Offline'; }
            else { iconEl.textContent='üîÑ'; textEl.textContent='Sincronizando...'; }
        };

        window.trocarAba = function(aba) {
            document.querySelectorAll('.auth-tab').forEach(t=>t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f=>f.classList.remove('active'));
            if (aba==='login') {
                document.querySelectorAll('.auth-tab')[0].classList.add('active');
                document.getElementById('formLogin').classList.add('active');
            } else {
                document.querySelectorAll('.auth-tab')[1].classList.add('active');
                document.getElementById('formRegistro').classList.add('active');
            }
        };

        window.fazerLogin = async function(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const senha = document.getElementById('loginSenha').value;
            mostrarLoading(true,'Fazendo login...');
            try {
                await signInWithEmailAndPassword(auth,email,senha);
            } catch(err) {
                mostrarLoading(false);
                alert('Erro ao fazer login: '+err.message);
            }
        };

        window.fazerRegistro = async function(e) {
            e.preventDefault();
            const email = document.getElementById('registroEmail').value;
            const senha = document.getElementById('registroSenha').value;
            const conf  = document.getElementById('registroConfirmaSenha').value;
            if (senha!==conf) { alert('As senhas n√£o conferem.'); return; }
            mostrarLoading(true,'Criando conta...');
            try {
                await createUserWithEmailAndPassword(auth,email,senha);
                alert('Conta criada. Voc√™ j√° est√° logado.');
            } catch(err) {
                mostrarLoading(false);
                alert('Erro ao criar conta: '+err.message);
            }
        };

        window.fazerLogout = async function() {
            if (!confirm('Deseja sair da conta?')) return;
            await signOut(auth);
        };

        window.carregarReceitas = async function() {
            if (!window.currentUserId) return [];
            const ref = collection(db,'usuarios',window.currentUserId,'receitas');
            const snap = await getDocs(ref);
            return snap.docs.map(d=>({id:d.id,...d.data()}));
        };

        window.salvarReceitaFirebase = async function(r) {
            if (!window.currentUserId) return;
            atualizarStatusSync('syncing');
            await setDoc(doc(db,'usuarios',window.currentUserId,'receitas',r.codigo),r);
            atualizarStatusSync('online');
        };

        window.excluirReceitaFirebase = async function(cod) {
            if (!window.currentUserId) return;
            atualizarStatusSync('syncing');
            await deleteDoc(doc(db,'usuarios',window.currentUserId,'receitas',cod));
            atualizarStatusSync('online');
        };

        window.carregarAplicacoes = async function() {
            if (!window.currentUserId) return {};
            const ref = doc(db,'usuarios',window.currentUserId,'dados','aplicacoes');
            const snap = await getDoc(ref);
            return snap.exists()?snap.data():{};
        };

        window.salvarAplicacoesFirebase = async function(apl) {
            if (!window.currentUserId) return;
            atualizarStatusSync('syncing');
            await setDoc(doc(db,'usuarios',window.currentUserId,'dados','aplicacoes'),apl);
            atualizarStatusSync('online');
        };

        window.iniciarSincronizacao = function() {
            if (!window.currentUserId) return;
            const recRef = collection(db,'usuarios',window.currentUserId,'receitas');
            onSnapshot(recRef,()=>{ console.log('Receitas atualizadas'); window.renderizarTabela?.(); });
            const aplRef = doc(db,'usuarios',window.currentUserId,'dados','aplicacoes');
            onSnapshot(aplRef,()=>{ console.log('Aplica√ß√µes atualizadas'); window.renderizarTabela?.(); });
        };

        async function inicializarApp() {
            window.iniciarSincronizacao();
            await window.gerarPlanoAplicacoes();
            await window.renderizarTabela();
        }

        onAuthStateChanged(auth, async (user)=>{
            if (user) {
                try {
                    window.currentUserId = user.uid;
                    document.getElementById('userEmail').textContent = user.email || '(sem e-mail)';
                    document.getElementById('authScreen').classList.remove('show');
                    mostrarLoading(true,'Carregando dados...');
                    atualizarStatusSync('online');
                    await inicializarApp();
                } catch(err) {
                    console.error(err);
                    alert('Erro ao carregar dados: '+err.message);
                } finally {
                    mostrarLoading(false);
                }
            } else {
                document.getElementById('authScreen').classList.add('show');
                mostrarLoading(false);
                atualizarStatusSync('offline');
            }
        });
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <script>
        const dosesPorCaixa = 3;
        window.planoAplicacoes = [];

        function formatarData(d) {
            const dia = String(d.getDate()).padStart(2,'0');
            const mes = String(d.getMonth()+1).padStart(2,'0');
            const ano = d.getFullYear();
            return `${dia}/${mes}/${ano}`;
        }

        function obterDiaSemana(d) {
            const dias = ['Domingo','Segunda','Ter√ßa','Quarta','Quinta','Sexta','S√°bado'];
            return dias[d.getDay()];
        }

        window.gerarPlanoAplicacoes = async function() {
            const receitas = await carregarReceitas();
            receitas.sort((a,b) => new Date(a.dataCadastro) - new Date(b.dataCadastro));

            const plano = [];
            let dataAtual = new Date(2026,1,7,12,0,0);
            const dataLimite = new Date(2026,11,31,12,0,0);

            for (const receita of receitas) {
                const intersticio = receita.intersticioAplicacao || 10;

                for (let i=0; i<dosesPorCaixa; i++) {
                    if (dataAtual <= dataLimite) {
                        plano.push({
                            data: new Date(dataAtual),
                            receita: receita.codigo,
                            intersticio: intersticio
                        });

                        if (i < dosesPorCaixa - 1) {
                            dataAtual.setDate(dataAtual.getDate() + intersticio);
                        }
                    }
                }

                if (receitas.indexOf(receita) < receitas.length - 1) {
                    const proximaReceita = receitas[receitas.indexOf(receita) + 1];
                    const proximoIntersticio = proximaReceita.intersticioAplicacao || 10;
                    dataAtual.setDate(dataAtual.getDate() + proximoIntersticio);
                }
            }

            window.planoAplicacoes = plano;
        };

        function gerarDatasAplicacao() {
            if (window.planoAplicacoes && window.planoAplicacoes.length > 0) {
                return window.planoAplicacoes.map(p => p.data);
            }

            const datas = [];
            let dataAtual = new Date(2026,1,7,12,0,0);
            const limite = new Date(2026,11,31,12,0,0);
            const intersticioDefault = 10;

            while (dataAtual <= limite) {
                datas.push(new Date(dataAtual));
                dataAtual.setDate(dataAtual.getDate() + intersticioDefault);
            }
            return datas;
        }

        async function atribuirReceita(dataStr) {
            const receitas = await carregarReceitas();
            const aplicacoes = await carregarAplicacoes();
            const uso = {};
            receitas.forEach(r=>uso[r.codigo]=0);
            Object.values(aplicacoes).forEach(reg=>{
                if (reg.aplicacao==='Sim' && reg.receita) uso[reg.receita] = (uso[reg.receita]||0)+1;
            });
            for (const r of receitas) {
                if ((uso[r.codigo]||0) < dosesPorCaixa) return r.codigo;
            }
            return null;
        }

        window.abrirModalReceita = function(codigo=null) {
            const modal = document.getElementById('modalReceita');
            const titulo = document.getElementById('modalReceitaTitulo');
            const idInput = document.getElementById('receitaEditandoId');

            if (codigo) {
                titulo.textContent = '‚úèÔ∏è Editar Receita';
                idInput.value = codigo;
                carregarReceitas().then(rs=>{
                    const r = rs.find(x=>x.codigo===codigo);
                    if (!r) return;
                    document.getElementById('codigoReceita').value = r.codigo;
                    const [d,m,a] = r.dataEmissao.split('/');
                    document.getElementById('dataEmissao').value = `${a}-${m}-${d}`;
                    if (r.dataValidade) {
                        const [dv,mv,av] = r.dataValidade.split('/');
                        document.getElementById('dataValidade').value = `${av}-${mv}-${dv}`;
                    } else document.getElementById('dataValidade').value='';
                    document.getElementById('observacoes').value = r.observacoes || '';
                    document.getElementById('intersticioAplicacao').value = r.intersticioAplicacao || 10;
                    document.getElementById('intersticioAplicacao').disabled = true;
                });
            } else {
                titulo.textContent = 'üìù Cadastrar Nova Receita';
                idInput.value='';
                document.getElementById('codigoReceita').value='';
                document.getElementById('dataEmissao').value='';
                document.getElementById('dataValidade').value='';
                document.getElementById('observacoes').value='';
                document.getElementById('intersticioAplicacao').value='10';
                document.getElementById('intersticioAplicacao').disabled = false;
            }
            modal.style.display='block';
        };

        window.fecharModalReceita = function() {
            document.getElementById('modalReceita').style.display='none';
        };

        window.salvarReceita = async function() {
            const codigo = document.getElementById('codigoReceita').value.trim();
            const emissao = document.getElementById('dataEmissao').value;
            const validade = document.getElementById('dataValidade').value;
            const obs = document.getElementById('observacoes').value.trim();
            const intersticio = parseInt(document.getElementById('intersticioAplicacao').value);
            const editId = document.getElementById('receitaEditandoId').value;

            if (!codigo || !emissao) { 
                alert('Preencha c√≥digo e data de emiss√£o.'); 
                return; 
            }

            if (!intersticio || intersticio < 1 || intersticio > 365) {
                alert('Interst√≠cio deve estar entre 1 e 365 dias.');
                return;
            }

            const receitas = await carregarReceitas();

            if (!editId && receitas.some(r=>r.codigo===codigo)) {
                alert('J√° existe receita com esse c√≥digo.'); 
                return;
            }

            if (editId && codigo!==editId && receitas.some(r=>r.codigo===codigo)) {
                alert('J√° existe receita com esse novo c√≥digo.'); 
                return;
            }

            if (editId && codigo!==editId) {
                const aplicacoes = await carregarAplicacoes();
                Object.keys(aplicacoes).forEach(data=>{
                    if (aplicacoes[data].receita===editId) aplicacoes[data].receita=codigo;
                });
                await salvarAplicacoesFirebase(aplicacoes);
                await excluirReceitaFirebase(editId);
            }

            const receitaExistente = receitas.find(r => r.codigo === (editId || codigo));
            const intersticioFinal = editId ? (receitaExistente?.intersticioAplicacao || 10) : intersticio;

            const rec = {
                codigo,
                dataEmissao: formatarData(new Date(emissao+'T12:00:00')),
                dataValidade: validade?formatarData(new Date(validade+'T12:00:00')):null,
                observacoes: obs||null,
                intersticioAplicacao: intersticioFinal,
                dataCadastro: receitaExistente?.dataCadastro || new Date().toISOString()
            };

            await salvarReceitaFirebase(rec);
            fecharModalReceita();

            if (!editId) {
                await gerarPlanoAplicacoes();
            }

            alert(editId?'Receita atualizada.':'Receita cadastrada. Datas recalculadas.');
        };

        window.excluirReceita = async function(codigo) {
            if (!confirm(`Excluir receita ${codigo}?`)) return;
            const apl = await carregarAplicacoes();
            Object.keys(apl).forEach(d=>{
                if (apl[d].receita===codigo) apl[d].receita=null;
            });
            await salvarAplicacoesFirebase(apl);
            await excluirReceitaFirebase(codigo);
            await gerarPlanoAplicacoes();
            alert('Receita exclu√≠da.');
        };

        async function podeEditarOuExcluir(receita, todas) {
            const ultima = todas[todas.length-1];
            if (!ultima || ultima.codigo!==receita.codigo) return false;
            const apl = await carregarAplicacoes();
            let usadas = 0;
            Object.values(apl).forEach(r=>{
                if (r.aplicacao==='Sim' && r.receita===receita.codigo) usadas++;
            });
            return usadas<dosesPorCaixa;
        }

        window.atualizarEstatisticas = async function() {
            const apl = await carregarAplicacoes();
            const recs = await carregarReceitas();
            const datas = gerarDatasAplicacao();
            const total = datas.length;

            const aplicadas = Object.values(apl).filter(x => 
                x.aplicacao === 'Sim' && x.receita !== null && x.receita !== undefined
            ).length;

            const nao = Object.values(apl).filter(x => x.aplicacao === 'N√£o').length;
            const taxa = total ? Math.round(aplicadas / total * 100) : 0;

            document.getElementById('totalAplicacoes').textContent = total;
            document.getElementById('totalAplicadas').textContent = aplicadas;
            document.getElementById('totalNaoAplicadas').textContent = nao;
            document.getElementById('taxaAdesao').textContent = taxa + '%';

            const totalRec = recs.length;

            const dosesUtilizadasPorReceita = {};
            recs.forEach(r => dosesUtilizadasPorReceita[r.codigo] = 0);

            Object.values(apl).forEach(registro => {
                if (registro.aplicacao === 'Sim' && registro.receita) {
                    dosesUtilizadasPorReceita[registro.receita] = 
                        (dosesUtilizadasPorReceita[registro.receita] || 0) + 1;
                }
            });

            const dosesUtilizadas = Object.values(dosesUtilizadasPorReceita).reduce((a, b) => a + b, 0);
            const dosesTotais = totalRec * dosesPorCaixa;
            const dosesDisponiveis = Math.max(0, dosesTotais - dosesUtilizadas);
            const nec = Math.ceil(total / dosesPorCaixa);

            document.getElementById('totalReceitas').textContent = totalRec;
            document.getElementById('dosesDisponiveis').textContent = dosesDisponiveis;
            document.getElementById('dosesUtilizadas').textContent = dosesUtilizadas;
            document.getElementById('receitasNecessarias').textContent = nec;

            await window.atualizarListaReceitas();
        };

        window.atualizarListaReceitas = async function() {
            const recs = await carregarReceitas();
            const apl = await carregarAplicacoes();
            const container = document.getElementById('receitasContainer');
            const bloco = document.getElementById('listaReceitas');
            if (!recs.length) { bloco.style.display='none'; return; }
            bloco.style.display='block';

            const uso={};
            recs.forEach(r=>uso[r.codigo]=0);
            Object.values(apl).forEach(r=>{
                if (r.aplicacao==='Sim' && r.receita) uso[r.receita]=(uso[r.receita]||0)+1;
            });

            const html=[];
            for (const r of recs) {
                const usadas = uso[r.codigo]||0;
                const perc = usadas/dosesPorCaixa*100;
                const status = usadas>=dosesPorCaixa?'Esgotada':'Ativa';
                const cls = usadas>=dosesPorCaixa?'receita-esgotada':'receita-ativa';
                const pode = await podeEditarOuExcluir(r,recs);
                html.push(`
                    <div class="receita-item">
                        ${pode?`<div class="receita-actions">
                            <button class="btn btn-warning btn-sm" onclick="abrirModalReceita('${r.codigo}')">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-sm" onclick="excluirReceita('${r.codigo}')">üóëÔ∏è</button>
                        </div>`:''}
                        <h4>${r.codigo} <span class="receita-badge ${cls}">${status}</span></h4>
                        <p><strong>Emiss√£o:</strong> ${r.dataEmissao}</p>
                        <p><strong>Interst√≠cio:</strong> ${r.intersticioAplicacao || 10} dias entre aplica√ß√µes</p>
                        ${r.dataValidade?`<p><strong>Validade:</strong> ${r.dataValidade}</p>`:''}
                        ${r.observacoes?`<p><strong>Obs:</strong> ${r.observacoes}</p>`:''}
                        <p><strong>Doses:</strong> ${usadas} de ${dosesPorCaixa} utilizadas</p>
                        <div class="progress-bar"><div class="progress-fill" style="width:${perc}%"></div></div>
                    </div>
                `);
            }
            container.innerHTML = html.join('');
        };

        window.renderizarTabela = async function() {
            const datas = gerarDatasAplicacao();
            const apl = await carregarAplicacoes();
            const receitas = await carregarReceitas();
            const tbody = document.getElementById('corpoTabela');
            tbody.innerHTML = '';

            const dosesUtilizadasPorReceita = {};
            receitas.forEach(r => dosesUtilizadasPorReceita[r.codigo] = 0);

            Object.values(apl).forEach(registro => {
                if (registro.aplicacao === 'Sim' && registro.receita) {
                    dosesUtilizadasPorReceita[registro.receita] = 
                        (dosesUtilizadasPorReceita[registro.receita] || 0) + 1;
                }
            });

            const temReceitaDisponivel = receitas.some(r => {
                const usadas = dosesUtilizadasPorReceita[r.codigo] || 0;
                return usadas < dosesPorCaixa;
            });

            datas.forEach((d, i) => {
                const dataStr = formatarData(d);
                const reg = apl[dataStr] || {aplicacao: '', receita: null};
                const cls = reg.aplicacao === 'Sim' ? 'aplicado-sim' : 
                           reg.aplicacao === 'N√£o' ? 'aplicado-nao' : '';

                const info = reg.receita ? 
                    `<small style="color:#667eea;">Receita: ${reg.receita}</small>` : 
                    '<small style="color:#999;">Nenhuma receita</small>';

                const tr = document.createElement('tr');
                const simDisabled = !temReceitaDisponivel && reg.aplicacao !== 'Sim';

                tr.innerHTML = `
                    <td><strong>${i + 1}</strong></td>
                    <td>${dataStr}</td>
                    <td>${obterDiaSemana(d)}</td>
                    <td>
                        <select class="${cls}" 
                                data-data="${dataStr}"
                                data-tem-receita="${temReceitaDisponivel}"
                                onchange="atualizarAplicacao('${dataStr}', this.value, this)">
                            <option value="">-- Selecione --</option>
                            <option value="Sim" ${reg.aplicacao === 'Sim' ? 'selected' : ''} ${simDisabled ? 'disabled' : ''}>
                                Sim${simDisabled ? ' (sem receita)' : ''}
                            </option>
                            <option value="N√£o" ${reg.aplicacao === 'N√£o' ? 'selected' : ''}>N√£o</option>
                        </select>
                    </td>
                    <td>${info}</td>
                `;

                tbody.appendChild(tr);
            });

            await atualizarEstatisticas();
        };

        window.atualizarAplicacao = async function(dataStr, valor, el) {
            const apl = await carregarAplicacoes();
            const temReceita = el.getAttribute('data-tem-receita') === 'true';

            if (!valor) {
                delete apl[dataStr];
                el.className = '';
            } else if (valor === 'Sim') {
                if (!temReceita) {
                    alert('N√£o h√° receitas com doses restantes.');
                    el.value = apl[dataStr]?.aplicacao || '';
                    el.className = apl[dataStr]?.aplicacao === 'N√£o' ? 'aplicado-nao' : '';
                    return;
                }

                const rec = await atribuirReceita(dataStr);

                if (!rec) {
                    alert('N√£o h√° receitas com doses restantes.');
                    el.value = apl[dataStr]?.aplicacao || '';
                    el.className = apl[dataStr]?.aplicacao === 'N√£o' ? 'aplicado-nao' : '';
                    return;
                }

                apl[dataStr] = {aplicacao: 'Sim', receita: rec};
                el.className = 'aplicado-sim';
            } else {
                apl[dataStr] = {aplicacao: 'N√£o', receita: null};
                el.className = 'aplicado-nao';
            }

            await salvarAplicacoesFirebase(apl);
        };

        window.marcarTodasSim = async function() {
            if (!confirm('Marcar todas as aplica√ß√µes como realizadas?')) return;
            const datas = gerarDatasAplicacao();
            const apl={};
            let ok=true;
            for (let i=0;i<datas.length;i++) {
                const dataStr = formatarData(datas[i]);
                const rec = await atribuirReceita(dataStr);
                if (!rec && ok) {
                    ok=false;
                    alert(`Receitas insuficientes a partir da aplica√ß√£o #${i+1}.`);
                }
                apl[dataStr]={aplicacao:'Sim',receita:rec};
            }
            await salvarAplicacoesFirebase(apl);
        };

        window.limparTodas = async function() {
            if (!confirm('Limpar todos os registros de aplica√ß√£o?')) return;
            await salvarAplicacoesFirebase({});
        };

        if ('serviceWorker' in navigator) {
            window.addEventListener('load',()=>{
                navigator.serviceWorker.register('service-worker.js').catch(()=>{});
            });
        }

        let deferredPrompt;
        window.addEventListener('beforeinstallprompt',e=>{
            e.preventDefault();
            deferredPrompt=e;
            document.getElementById('installPrompt').classList.add('show');
        });

        window.instalarApp = function() {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            deferredPrompt.userChoice.finally(()=>{
                deferredPrompt=null;
                document.getElementById('installPrompt').classList.remove('show');
            });
        };

        window.fecharPromptInstalacao = function() {
            document.getElementById('installPrompt').classList.remove('show');
        };

        window.exportarPDF = async function() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(18);
            doc.setTextColor(102,126,234);
            doc.text('Relat√≥rio de Controle de Medica√ß√£o',14,20);
            doc.setFontSize(10);
            doc.setTextColor(0,0,0);
            doc.text('Cipionato de Testosterona',14,28);
            doc.text('Per√≠odo: 07/02/2026 a 31/12/2026',14,34);
            doc.text('Intervalo: Vari√°vel conforme receita',14,40);
            doc.text('Gerado em: '+formatarData(new Date()),14,46);

            const apl = await carregarAplicacoes();
            const recs = await carregarReceitas();
            const datas = gerarDatasAplicacao();
            const aplicadas = Object.values(apl).filter(v=>v.aplicacao==='Sim' && v.receita).length;
            const nao = Object.values(apl).filter(v=>v.aplicacao==='N√£o').length;
            const taxa = datas.length?Math.round(aplicadas/datas.length*100):0;

            doc.setFontSize(11);
            doc.setTextColor(102,126,234);
            doc.text('Estat√≠sticas',14,56);
            doc.setFontSize(10);
            doc.setTextColor(0,0,0);
            doc.text(`Previstas: ${datas.length}`,14,62);
            doc.text(`Realizadas: ${aplicadas}`,14,68);
            doc.text(`N√£o realizadas: ${nao}`,14,74);
            doc.text(`Taxa de ades√£o: ${taxa}%`,14,80);

            if (recs.length) {
                const uso={};
                recs.forEach(r=>uso[r.codigo]=0);
                Object.values(apl).forEach(r=>{
                    if (r.aplicacao==='Sim' && r.receita) uso[r.receita]=(uso[r.receita]||0)+1;
                });
                const linhas = recs.map(r=>{
                    const usadas=uso[r.codigo]||0;
                    const status=usadas>=dosesPorCaixa?'Esgotada':'Ativa';
                    return [r.codigo,r.dataEmissao,`${r.intersticioAplicacao||10} dias`,`${usadas}/${dosesPorCaixa}`,status];
                });
                doc.autoTable({
                    startY:88,
                    head:[['C√≥digo','Emiss√£o','Interst√≠cio','Doses','Status']],
                    body:linhas
                });
            }
            doc.save('Controle_Medicacao.pdf');
        };
    </script>
</body>
</html>
